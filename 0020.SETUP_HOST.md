# partyappホストの構築

## １．初期設定/準備

### 1.1. 前提

- SSHサーバーがインストールされたUbuntu24.04の仮想マシンを作成済
- 動作要件: 2vcpu/4GB mem/32GB storage
- ローカルホスト(Ubuntuを操作するWinやMac)のターミナルでSSHクライアントが利用可能

### 1.2. SSH接続設定

#### 1.2.1. ローカルホストでSSH鍵ペアの作成(作っていない場合は作ることを推奨)

SSH鍵ペアは、デフォルト作成済のもの(```id_rsa```)を使ってもよいが、自分用に1つ作成しておくことを推奨。  

Ubuntu24.04を操作するためのローカルホストのターミナルソフトを使って、自身の鍵ペアを作成する。  
鍵名```new_keys```は適宜自身の好みに合わせたものにすること。  
\~/.sshフォルダがない場合は、自身で作成すること。  
MACの場合は、\~/.sshフォルダのアクセス権限を```chmod 700 ~/.ssh```で設定することを推奨。

```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/new_keys
```

~/.sshに、公開鍵と秘密鍵のペアが作成される。  
公開鍵: new_keys.pub  
秘密鍵: new_keys

MACの場合は、```chmod 600 ~/.ssh/ew_keys```で秘密鍵のパーミッションを```600```に設定を推奨。

#### 1.2.2. ローカルホストの公開鍵をリモートホストへコピー

手順

ローカルホストの```公開鍵```をリモートホストにコピーする。

ローカルホストのシェル(powershell or terminal)から、以下のコマンドを実行。  
公開鍵ファイル名(new_keys.pub), リモートホストユーザ名(remote_host_username), リモートホストIPアドレス(192.168.0.165)は、適宜自身の環境に置き換えること。  
copyの際、リモートホストのログインを求められる。

```powershell
cd $HOME/.ssh
ssh-copy-id -i new_keys.pub remote_host_username@192.168.0.165
```

#### 1.2.3. ローカルホストにリモートホストへのSSH接続を設定

$HOME/.ssh/configに、以下を追記。  
```IdentityFile```は、秘密鍵をフルパスで指定。(```~```は多分使える)  
remote_host_username(リモートホスト名), ```秘密鍵```ファイル名(new_keys), リモートホストユーザ名(remote_host_username), リモートホストIPアドレス(192.168.0.165)は、適宜自身の環境に置き換えること。  

```ini
Host remote_host_name
    User remote_host_username
    Hostname 192.168.0.165
    IdentityFile ~\.ssh\new_keys
    ServerAliveInterval  60
```

#### 1.2.4. ローカルホストからSSHでリモートホストへ接続

ローカルホストのターミナルからsshコマンドで接続して動作確認をする。  
remote_host_name(リモートホスト名)は、適宜自身の環境に置き換えること。  

```bash
ssh remote_host_name
```

### 1.3. リモートホストの初期設定

#### 1.3.1. sudoersの設定

リモートホスト管理者ユーザーがsudoでコマンドを実行するたびにパスワードを求められないようにする。

以下のコマンドを実行すると、/etc/sudoersが```nano```エディタで開く

```bash
sudo visudo
```

最後尾に、以下の1行を追加。  
remote_host_usernameは、適宜自身の環境に置き換えること。  

```text
remote_host_username ALL=NOPASSWD: ALL
```

nanoの修正保存は```Ctrl+X```の後、変更保存するか確認されるので、```Y```+```Enter```

### 1.3.2 Ubuntuパッケージの更新

OSの更新をする。

```bash
sudo apt update
sudo apt upgrade
```

### 1.3.3. タイムゾーンの設定

初期設定ではUTCになっているので、JSTに変更しておく。

```bash
sudo timedatectl set-timezone Asia/Tokyo
```

確認

```bash
timedatectl
```

```Time zone: Asia/Tokyo (JST, +0900)```と出力されていればOK。

## ２．リモートホストにpython仮想環境を構築

### 2.1. 必要なdebパッケージのインストール

Pythonで利用する一部のパッケージは、debパッケージでインストールする。
sshでリモートホストに接続/ログイン後、

```bash
sudo apt update
sudo apt install python3-pip python3-venv
```

### 2.2. フォルダ構成

ここでは、以下のフォルダ構成でpython開発環境を作成していく。  
開発するアプリケーション毎に、専用のPython仮想環境=アプリケーション専用の実行環境を作成することを推奨。

```text
$HOME
  └── partyapp_workspace
        ├─ partyapp/                # ここにアプリケーションを作成
        └─ .partyapp                # このアプリケーションのpython仮想環境
```

- $HOME  
  ubuntuのユーザーホームディレクトリのパスが格納された環境変数。  
  bashコマンドで、ユーザーホームディレクトリのフルパスとして使える。
- partyapp_workspace  
  ```partyapp```アプリケーションのワークスペースフォルダ。  
- partyapp  
  ```partyapp```アプリケーションの本体のコードをこのフォルダ配下に作成する。
- .partyapp  
  ```partyapp```アプリケーションのPython仮想環境フォルダ(仮想環境作成手順は後述)。

### 2.3. パッケージのインストール

以下のパッケージをubuntuのdebパッケージでインストールしておく。  
Python仮想環境の構築に必要。

```bash
sudo apt update
sudo apt install python3-pip python3-venv
```

### 2.4. 仮想環境の構築
 
Ubuntuの場合、python3.xのインタープリタ(```python3```)が標準でインストール済であり、パスも通っている。

```python
cd $HOME/partyapp_workspace
python3 -m venv .partyapp
```

\$HOME/partyapp_workspace/.partyapp配下に実行環境が作成される。

### 2.5. 仮想環境のアクティベート

仮想環境のインタープリタを使って、アクティベート。

```bash
source $HOME/partyapp_workspace/.partyapp/bin/activate
```

補足  

- ログインするたびに仮想環境をアクティベートするのが面倒な場合は、~/.basrcの最後尾に  
  ```source $HOME/partyapp_workspace/.partyapp/bin/activate```
  を追記するとターミナル接続時に自動でアクティベートしてくれる。  
- 仮想環境をアクティベートせずに仮想環境のスクリプトを動かすときは、仮想環境のpythonインタープリタやpip等のモジュールをフルパスで指定する。  
  インタープリタ： \$HOME/partyapp_workspace/.partyapp/bin/python  
  pip: \$HOME/workspace/.workspace/bin/pip  
  例：　hello-world.pyを仮想環境をアクティベートせずに実行する  
  \$HOME/workspace/.workspace/bin/python hello-world.py

### 2.6. 仮想環境のpipを最新化

仮想環境をアクティベートした状態で、以下を実行

```bash
pip install --upgrade pip
```

## ３．VSCodeの設定

### 3.1. VSCodeからリモートホストに接続

リモートホストで仮想環境を構築したら、ローカルのVSCodeを起動。  

VSCodeに、拡張機能```Remote Explorer```がインストールされていない場合はインストール。  
VSCodeの```Remote Explorer```を使って、リモートホストのworkspaceフォルダに接続。

### 3.2. リモートホスト用のPython拡張機能のインストール

```Remote Explorer```を使う場合、一部のVSCode拡張機能はリモートホスト毎にインストールする必要がある!!!  
上記で仮想環境を作成したリモートホストのためにVSCodeのpython拡張機能をインストールする。

### 3.3. デバッグツールとしてのjupyterlab

データを収集したり加工したりする際は、VSCodeのデバッグ機能を使ってデバッグするよりも、```jpyterlab```を使った方が圧倒的に効率的。  

リモートホストの仮想環境にpythonのjupyterlabをインストールする。  
仮想環境がアクティベートされた状態で、以下を実行。

```bash
pip install jupyterlab
```

VSCodeに、```jupyterlab```の拡張機能をインストールする。  
ローカルホスト、リモートホストの両方必要なので、ローカルに```jupyterlab```インストール後、リモートホストに接続した状態でリモートホストに```jupyterlab```の拡張機能をインストールする。
