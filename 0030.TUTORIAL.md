# チュートリアル

- [チュートリアル](#チュートリアル)
  - [１．前提](#１前提)
  - [２．コーディングの準備](#２コーディングの準備)
  - [３．パッケージとモジュールと\_\_init\_\_.pyについて](#３パッケージとモジュールと__init__pyについて)
  - [４．SQLAlchemyのデータベースハンドラを生成するライブラリの作成](#４sqlalchemyのデータベースハンドラを生成するライブラリの作成)
  - [５．データベースモデルの作成](#５データベースモデルの作成)
    - [5.1. enum型の定義ファイルを作成](#51-enum型の定義ファイルを作成)
    - [5.2. テーブルモデルを作成](#52-テーブルモデルを作成)
    - [5.3. テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成](#53-テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成)
  - [６．初期化コマンドなど、コマンド用スクリプトの作成](#６初期化コマンドなどコマンド用スクリプトの作成)
  - [７．pyproject.tomlの設置とパッケージとしてインストール](#７pyprojecttomlの設置とパッケージとしてインストール)
  - [８．テーブルの作成](#８テーブルの作成)
  - [９．モデルスキーマの変更](#９モデルスキーマの変更)
    - [9.1. alembicのpipインストール](#91-alembicのpipインストール)
    - [9.2. モデルの修正](#92-モデルの修正)
    - [9.3. alembicの環境作成](#93-alembicの環境作成)
    - [9.4. alembic設定ファイルの編集](#94-alembic設定ファイルの編集)
    - [9.5. 差分検出をする](#95-差分検出をする)
    - [9.6. マイグレーションコマンドファイルの手動変更](#96-マイグレーションコマンドファイルの手動変更)
    - [9.7. 検出した差分を使って、alembicでDBをマイグレーションする](#97-検出した差分を使ってalembicでdbをマイグレーションする)
    - [9.8.確認](#98確認)
    - [9.9. DBスキーマのdowngrade](#99-dbスキーマのdowngrade)
  - [１０．マスターテーブルデータのシードのアップサート](#１０マスターテーブルデータのシードのアップサート)
  - [10.1. シードデータの作成](#101-シードデータの作成)
  - [10.2. シードデータのアップサート](#102-シードデータのアップサート)

## １．前提

- ```partyapp```の仮想環境を構築済
- ```partyapp```が連携するDBサーバを構築済である
- ```partyapp```の仮想環境がアクティベート済である

## ２．コーディングの準備

まずは、partyapp/requirements.txtを作成(実ファイルを参照のこと)

つづいて、```partyapp```で利用する外部パッケージのインストール。

```bash
cd ~/partyapp_workspace/partyapp
pip install -r requirements.txt
```

mysqlの接続情報を環境変数として設定する。  
接続時に自動設定されるように、```~/.bashrc```の最後尾に追記しておく。  
設定値は適宜自身の環境に合わせること。

```bash
export DB_USER="username"
export DB_PASSWORD="password"
export DB_HOST="192.168.0.165"
export DB_PORT="3306"
export DB_NAME="partyapp"
# export PYTHONPATH=$HOME/partyapp_workspace:$PYTHONPATH ← 不要になった
```

接続時に読み込まれ、自動設定されるようになる。ただし、即時反映させたい場合は

```bash
source ~/.bashrc
```

## ３．パッケージとモジュールと__init__.pyについて

```モジュール```とは、pythonスクリプトが書かれたファイルのこと。  
外部モジュールからのオブジェクトのimportは、  
```from モジュール名 import オブジェクト名```  
の構文でimportする

モジュールが保存されているディレクトリのことを、```パッケージ```という。  
カレントディレクトリ配下にないパッケージへのパスは、環境変数```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスを追加しておく必要あり。  
Pythonインタープリタは、```PYTHONPATH```、または、```sys.path```にセットされたパスからモジュールを探す仕組となっているため。

上位パッケージのみが```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスとして追加されている場合は、以下のように上位パッケージから記述することでオブジェクトをimport可能。  
```from package0.package1.module import object```

この例のpackage1が```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスとして追加されていない場合は、  
```from package1 import object```  
と書いても```package1```をサーチできず、importに失敗する。

```partyapp```フォルダ配下の各フォルダにある```__init__.py```は、多くが空っぽのファイルになっている。  
これは、```python3.2```以前は、```__init__.py```ファイルが、フォルダをパッケージとして認識するための識別子として必須であったことの名残。  
```python3.3```以降は、```__init__.py```がなくても、pythonインタープリタはフォルダをパッケージとして認識してくれる。  
ただし、```__init__.py```があるフォルダはパッケージであると人が読んで認識しやすいので、可読性をあげるために不要でも慣例的に作成しているケースもあるとのこと。

## ４．SQLAlchemyのデータベースハンドラを生成するライブラリの作成

SQLAlchemyが```partyappdb```データベースを操作するためのデータベースハンドラを生成するライブラリ  
```partyapp/db/base.py```を作成。

## ５．データベースモデルの作成

### 5.1. enum型の定義ファイルを作成

列挙型データの型定義ファイル  
```partyapp/db/models/enums.py```を作成。

### 5.2. テーブルモデルを作成

各```メイン```テーブルのmodelを定義したモジュールを作成。

- ```partyapp/db/models/party.py```を作成。
- ```partyapp/db/models/category.py```を作成。
- ```partyapp/db/models/law.py```を作成。

各```アソシエーション```テーブルを1つのファイルにまとめて作成

- ```partyapp/db/models/associations.py```を作成。

なお、SQLAlchemyのモデルの概要については、```0040.MODEL.md```参照のこと。

### 5.3. テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成

アプリケーションからモデルをまとめてimportできるように、```partyapp/db/models```のパッケージファイルを作成

- ```partyapp/db/models/__init__.py```の作成

## ６．初期化コマンドなど、コマンド用スクリプトの作成

最初に、partyappdbにテーブルを作成したりするための操作を、コマンド化するためのファイルを作成しておく。  

- ```partyapp/cli.py```の作成

cli.pyの使い方

```text
以下のコマンドは、あとで純粋なlinuxコマンドとして利用できるように設定しなおすので、とりあえずこの場でのcli.pyの動作確認にのみ使う。
```

```partyapp```ディレクトリで、以下を実行。

```bash
# コマンド型式
# python -m partyapp.cli <コマンド関数名>
#
# 注意！！コマンド関数名の"_"(アンダースコア)は、"-"(ハイフン)に変換されるので要注意！！
# 関数connect_dbは、コマンドではconnect-dbとなる!!
#
#

python -m partyapp.cli connect-db

# ヘルプの表示
# コマンド型式
# python -m partyapp.cli <コマンド関数名> --help
python -m partyapp.cli connect-db --help

# コマンド一覧の表示
python -m partyapp.cli --help
```

ここに、テーブル一覧の表示とか、テーブルスキーマの表示とか、便利なコマンドを適宜追加していくと良い。

point:  
```cli.py```の中に、```def cli()```が定義されていない。  
代わりに、```cli = typer.Typer()```で、```typer.Typer```クラスのインスタンス```cli```を生成している。。  
この動作については、python classの特殊メソッドである```__call__```の動作を確認すること。  
classで```__call__```メソッドを定義することにより、生成したインスタンス(ここでは、```cli```)は、関数のように呼び出すことができるようになる。

## ７．pyproject.tomlの設置とパッケージとしてインストール

```pyproject.toml```を作成して```partyapp```自体を```pip```で```仮想環境```にインストールする。  
こうすることで、pythonパスを気にすることなく、プロジェクトフォルダ内のモジュールからオブジェクトをインストールできる。
以下のようにimportする。

```python
# importの起点はpartyappになる
from partyapp.db.base import Base, engine 
```

また、[上記](#６初期化コマンドなどコマンド用スクリプトの作成)で作成したコマンド関数を、純粋なlinuxコマンドとして利用可能になる。  
これも大変便利(下記参照)。

- ```partyapp/pyproject.toml```の作成  
  setauptoolsがこのファイルを読み込んで、partyappをパッケージとしてインストールしてくれる。
- ```partyapp/requirements.txt```に1行```-e .```を追記  
  ```-e```オプションをつけておくと、partyappのコードの修正を何もしなくても自動で反映してくれる(editableモード)。  
  ```.```は、カレントディレクトリをインストールするという意味。  
- 仮想環境をアクティベートしたターミナルで```partyapp```ディレクトリに移動し、```pip install -r requirements.txt```を実行して```partyapp```をインストール。

補足  
```pyproject.toml```に```partyapp.cli:cli```の設定をを追加することにより、cli.pyに記述した各コマンド関数は、以下のように純粋なlinuxコマンドのように実行できるようになる。  
(```partyapp/pyproject.toml```でコマンド名を```pa```に設定している)

```bash
# 書式
# pa option
# pa command [args|option]
# 例
pa --help
pa connect-db
pa connect-db --help
pa show-model-schema Party
```

## ８．テーブルの作成

[上記](#６初期化コマンドなどコマンド用スクリプトの作成)で作成した```cli.py```の```init_db```コマンドを使って、```partyappdb```に空のテーブルを作成する。  
```pa init-db```コマンドは、テーブルの修正は行わないので注意。最初に1回だけ実行。  
また、作成済テーブルは無視して存在しないテーブルのみを作成する。

```bash
pa init-db
```

## ９．モデルスキーマの変更

```alembic```を使って、各モデルのid列を```str```としていたが、idの自動生成をインクリメンタルな整数の自動生成に書き換える。  
作成したテーブルを全消し、再作成しても良いが、せっかくなので、alembicのDBマイグレーション機能を使ってみる。  
  
```alembic```は、データベースのスキーマ変更を、安全に・履歴管理しながら反映する(マイグレーション)ツール。  
DBスキーマを前のレビジョンに戻したりもできる。  

本項(モデルスキーマの変更)で実施すること  

- step1: 修正したモデルとDBスキーマの差分を検出し、DBをモデルに合わせてマイグレーションするコードを自動生成する
- step2: alembicコマンドでstep1のコードを利用し、DBスキーマを修正する。  
- step3: マイグレーションしたDBスキーマを元のDBスキーマにもどす。

なお、以下では、step1でalemicが生成したコードがうまく動作せず、結局、手動で大幅に書き換えることとなってしまった。

### 9.1. alembicのpipインストール

```partyapp/requirements.txt```にalembicを追加して、

```bash
pip install -r requirements.txt
```

### 9.2. モデルの修正

```partyapp/db/models```の各ファイルに保存されたモデルのid列を、```autoincrement=True```の整数型に変更する。  
各モデルのid列は、mysqlがインクリメンタルな整数を自動付与するので、データinsert時は、不要になる。

### 9.3. alembicの環境作成

partyappのコンテンツとは関係ないフォルダが作成されるので、```partyapp_workspace```フォルダで以下を実行。

```bash
cd $HOME/partyapp_workspace
alembic init alembic
```

```partyapp_workspace/alembic```が作成される。  
この配下のファイルを使ってalembicはDBとモデルの差分を検出し、DBマイグレーションを実行する。

### 9.4. alembic設定ファイルの編集

```alembic/env.py```を編集して、alembic実行時に```partyapp```のモデル情報を読み込めるようにする。

### 9.5. 差分検出をする

mysqlとモデルの差分を検出し、mysqlのスキーマを変更したモデルで定義したスキーマにマイグレーションするためのスクリプトを自動生成する。```partyapp_workspace```フォルダで以下のコマンドを実行。

```bash
cd $HOME/partyapp_workspace
alembic revision --autogenerate -m "change id columns to Integer autoincrement"
```

```partyapp_workspace```フォルダに、```alembic```フォルダが生成される。
自動生成されるマイグレーションスクリプトは、
```partyapp_workspace/alembic/versions/<リビジョンID>_<message>_.py```の形式で保存される。  
例： ```0ae425c23127_change_id_columns_to_integer_.py```

### 9.6. マイグレーションコマンドファイルの手動変更

mysqlは、Foreign Keyが参照するIDをdropできない仕様になっているため、自動生成したスクリプトでマイグレーションをすると、マイグレーションがエラーになってしまった。

このため、結局、alembicのdbマイグレーションスクリプトは手動で書き換えた。

修正ファイルのパスは、以下。  
xxxxの部分は、alembicが自動付与したマイグレーションのリビジョンID。

```partyapp_workspace/alembic/versions/xxxxxxxxxxxx_change_id_columns_to_integer_autoincrement_.py```

### 9.7. 検出した差分を使って、alembicでDBをマイグレーションする

以下のコマンドを実行することで、検出した差分を使って、partyappdbをマイグレーションしてくれる。

```bash
alembic upgrade head
```

### 9.8.確認

partyapp_dbにSSHアクセス。  
コンソールからdockerコマンド経由でpartyap_dbにsqlを実行。  
マイグレーションの中身を確認する。

```bash
docker exec -it partyapp_db mariadb -u root -p partyapp -e "SHOW CREATE TABLE M_PARTY\G"
docker exec -it partyapp_db mariadb -u root -p partyapp -e "SHOW CREATE TABLE M_CATEGORY\G"
docker exec -it partyapp_db mariadb -u root -p partyapp -e "SHOW CREATE TABLE T_LAW\G"
docker exec -it partyapp_db mariadb -u root -p partyapp -e "SHOW CREATE TABLE T_PARTY_LAW_ROLE\G"
docker exec -it partyapp_db mariadb -u root -p partyapp -e "SHOW CREATE TABLE T_LAW_CATEGORY_MAP\G"
```

### 9.9. DBスキーマのdowngrade

再び```partyapp```にSSH接続。  
alembicで前のDBスキーマにに戻す。

今の位置を確認。

```bash
$ alembic current
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
0ae425c23127 (head)
```

alembicのマイグレーション履歴の確認

```bash
$ alembic history --verbose
Rev: 0ae425c23127 (head)
Parent: <base>
Path: /home/ogs-digilife/partyapp_workspace/alembic/versions/0ae425c23127_change_id_columns_to_integer_.py

    change id columns to Integer autoincrement
    
    Revision ID: 0ae425c23127
    Revises: 
    Create Date: 2025-09-07 17:32:13.024776
```

レビジョンを1つ戻す

```bash
alembic downgrade -1
```

状態の確認。デフォルトに戻っている。

```bash
$ alembic current
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
```

## １０．マスターテーブルデータのシードのアップサート

```partyapp/cli.py```に、マスターテーブルの初期データ(シード)を登録するコマンドを作成しておく。

## 10.1. シードデータの作成

対象は、PartyモデルとCategoryモデル。
シードデータはcsv型式のファイルを/partyapp/seeds/に作成する。

```bash
mkdir $HOME/patyapp_workspace/partyapp/seeds
```

以下の2つの初期登録データ用のcsvファイルを作成

- partyapp/seeds/Party.csv
- partyapp/seeds/Category.csv

## 10.2. シードデータのアップサート

```patyapp/cli.py```にマスターデータのupsertツールを作成したので、利用する。

```bash
pa seed-master
```
