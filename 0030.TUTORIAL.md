# チュートリアル

- [チュートリアル](#チュートリアル)
  - [１．前提](#１前提)
  - [２．コーディングの準備](#２コーディングの準備)
  - [３．パッケージとモジュールと\_\_init\_\_.pyについて](#３パッケージとモジュールと__init__pyについて)
  - [４．SQLAlchemyのデータベースハンドラを生成するライブラリの作成](#４sqlalchemyのデータベースハンドラを生成するライブラリの作成)
  - [５．データベースモデルの作成](#５データベースモデルの作成)
    - [5.1. enum型の定義ファイルを作成](#51-enum型の定義ファイルを作成)
    - [5.2. テーブルモデルを作成](#52-テーブルモデルを作成)
    - [5.3. テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成](#53-テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成)
  - [６．初期化コマンドなど、コマンド用スクリプトの作成](#６初期化コマンドなどコマンド用スクリプトの作成)
  - [７．pyproject.pyの設置とパッケージとしてインストール](#７pyprojectpyの設置とパッケージとしてインストール)
  - [８．テーブルの作成](#８テーブルの作成)

## １．前提

- ```partyapp```の仮想環境を構築済
- ```partyapp```が連携するDBサーバを構築済である
- ```partyapp```の仮想環境がアクティベート済である

## ２．コーディングの準備

まずは、partyapp/requirements.txtを作成(実ファイルを参照のこと)

つづいて、```partyapp```で利用する外部パッケージのインストール。

```bash
cd ~/partyapp_workspace/partyapp
pip install -r requirements.txt
```

mysqlの接続情報を環境変数として設定する。  
接続時に自動設定されるように、```~/.bashrc```の最後尾に追記しておく。  
設定値は適宜自身の環境に合わせること。

```bash
export DB_USER="username"
export DB_PASSWORD="password"
export DB_HOST="192.168.0.165"
export DB_PORT="3306"
export DB_NAME="partyapp"
# export PYTHONPATH=$HOME/partyapp_workspace:$PYTHONPATH ← 不要になった
```

接続時に読み込まれ、自動設定されるようになる。ただし、即時反映させたい場合は

```bash
source ~/.bashrc
```

## ３．パッケージとモジュールと__init__.pyについて

```モジュール```とは、pythonスクリプトが書かれたファイルのこと。  
外部モジュールからのオブジェクトのimportは、  
```from モジュール名 import オブジェクト名```  
の構文でimportする

モジュールが保存されているディレクトリのことを、```パッケージ```という。  
カレントディレクトリ配下にないパッケージへのパスは、環境変数```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスを追加しておく必要あり。  
Pythonインタープリタは、```PYTHONPATH```、または、```sys.path```にセットされたパスからモジュールを探す仕組となっているため。

上位パッケージのみが```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスとして追加されている場合は、以下のように上位パッケージから記述することでオブジェクトをimport可能。  
```from package0.package1.module import object```

この例のpackage1が```PYTHONPATH```、または、```sys.path```オブジェクトにパッケージのパスとして追加されていない場合は、  
```from package1 import object```  
と書いても```package1```をサーチできず、importに失敗する。

```partyapp```フォルダ配下の各フォルダにある```__init__.py```は、多くが空っぽのファイルになっている。  
これは、```python3.2```以前は、```__init__.py```ファイルが、フォルダをパッケージとして認識するための識別子として必須であったことの名残。  
```python3.3```以降は、```__init__.py```がなくても、pythonインタープリタはフォルダをパッケージとして認識してくれる。  
ただし、```__init__.py```があるフォルダはパッケージであると人が読んで認識しやすいので、可読性をあげるために不要でも慣例的に作成しているケースもあるとのこと。

## ４．SQLAlchemyのデータベースハンドラを生成するライブラリの作成

SQLAlchemyが```partyappdb```データベースを操作するためのデータベースハンドラを生成するライブラリ  
```partyapp/db/base.py```を作成。

## ５．データベースモデルの作成

### 5.1. enum型の定義ファイルを作成

列挙型データの型定義ファイル  
```partyapp/db/models/enums.py```を作成。

### 5.2. テーブルモデルを作成

各```メイン```テーブルのmodelを定義したモジュールを作成。

- ```partyapp/db/models/party.py```を作成。
- ```partyapp/db/models/category.py```を作成。
- ```partyapp/db/models/law.py```を作成。

各```アソシエーション```テーブルを1つのファイルにまとめて作成

- ```partyapp/db/models/associations.py```を作成。

なお、SQLAlchemyのモデルの概要については、```0040.MODEL.md```参照のこと。

### 5.3. テーブルモデルをまとめて読み込ませるパッケージ初期化ファイルの作成

アプリケーションからモデルをまとめてimportできるように、```partyapp/db/models```のパッケージファイルを作成

- ```partyapp/db/models/__init__.py```の作成

## ６．初期化コマンドなど、コマンド用スクリプトの作成

最初に、partyappdbにテーブルを作成したりするための操作を、コマンド化するためのファイルを作成しておく。  

- ```partyapp/cli.py```の作成

cli.pyの使い方

```text
以下のコマンドは、あとで純粋なlinuxコマンドとして利用できるように設定しなおすので、とりあえずこの場でのcli.pyの動作確認にのみ使う。
```

```partyapp```ディレクトリで、以下を実行。

```bash
# コマンド型式
# python -m partyapp.cli <コマンド関数名>
#
# 注意！！コマンド関数名の"_"(アンダースコア)は、"-"(ハイフン)に変換されるので要注意！！
# 関数connect_dbは、コマンドではconnect-dbとなる!!
#
#

python -m partyapp.cli connect-db

# ヘルプの表示
# コマンド型式
# python -m partyapp.cli <コマンド関数名> --help
python -m partyapp.cli connect-db --help

# コマンド一覧の表示
python -m partyapp.cli --help
```

ここに、テーブル一覧の表示とか、テーブルスキーマの表示とか、便利なコマンドを適宜追加していくと良い。

## ７．pyproject.pyの設置とパッケージとしてインストール

```pyproject.toml```を作成して```partyapp```自体を```pip```で```仮想環境```にインストールする。  
こうすることで、pythonパスを気にすることなく、プロジェクトフォルダ内のモジュールからオブジェクトをインストールできる。
以下のようにimportする。

```python
# importの起点はpartyappになる
from partyapp.db.base import Base, engine 
```

また、[上記](#６初期化コマンドなどコマンド用スクリプトの作成)で作成したコマンド関数を、純粋なlinuxコマンドとして利用可能になる。  
これも大変便利(下記参照)。

- ```partyapp/pyproject.toml```の作成  
  setauptoolsがこのファイルを読み込んで、partyappをパッケージとしてインストールしてくれる。
- ```partyapp/requirements.txt```に1行```-e .```を追記  
  ```-e```オプションをつけておくと、partyappのコードの修正を何もしなくても自動で反映してくれる(editableモード)。  
  ```.```は、カレントディレクトリをインストールするという意味。  
- 仮想環境をアクティベートしたターミナルで```partyapp```ディレクトリに移動し、```pip install -r requirements.txt```を実行して```partyapp```をインストール。

補足  
```pyproject.toml```に```partyapp.cli:cli```の設定をを追加することにより、cli.pyに記述した各コマンド関数は、以下のように純粋なlinuxコマンドのように実行できるようになる。  
(```partyapp/pyproject.toml```でコマンド名を```pa```に設定している)

```bash
# 書式
# pa option
# pa command [args|option]
# 例
pa --help
pa connect-db
pa connect-db --help
pa show-model-schema Party
```

## ８．テーブルの作成

[上記](#６初期化コマンドなどコマンド用スクリプトの作成)で作成した```cli.py```の```init_db```コマンドを使って、```partyappdb```に空のテーブルを作成する。  
```pa init-db```コマンドは、テーブルの修正は行わないので注意。最初に1回だけ実行。  
また、作成済テーブルは無視して存在しないテーブルのみを作成する。

```bash
pa init-db
```
